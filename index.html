<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dare Me</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="dareme.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dare Me">
    <meta name="theme-color" content="#0a0a0a">
    
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
        "firebase/analytics": "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"
      }
    }
    </script>

    <style>
        :root { 
            --bg: #0a0a0a; 
            --gold: #d4af37; 
            --red: #b30000; 
            --text: #eee; 
            --panel: #111;
            --border: #333;
        }

        * { box-sizing: border-box; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            padding: 0; 
            margin: 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .page { display: none; width: 100%; max-width: 500px; padding: 20px; box-sizing: border-box; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .active { display: block; }

        @media (min-width: 1000px) {
            .page { max-width: 900px; }
            .task-text { font-size: 3.5rem !important; }
            h1 { font-size: 5rem !important; }
        }

        .logo-container {
            width: 280px; 
            height: 280px;
            margin: 10px auto 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulseGlow 4s infinite ease-in-out;
        }

        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 20px;
        }

        .small-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulseGlow 4s infinite ease-in-out;
        }
        .small-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        @keyframes pulseGlow {
            0% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.1)); }
            50% { transform: scale(1.02); filter: drop-shadow(0 0 25px rgba(212, 175, 55, 0.4)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.1)); }
        }

        h1 { color: var(--gold); letter-spacing: 5px; margin: 10px 0 30px 0; text-transform: uppercase; font-size: 2.2rem; }
        
        .intro-text-container { margin: 30px 0; line-height: 1.8; letter-spacing: 1px; }
        .intro-title { color: var(--gold); font-size: 1.6rem; text-transform: uppercase; margin-bottom: 20px; display: block; }
        .intro-body { color: #888; font-style: italic; font-size: 1.1rem; }
        .intro-highlight { color: #bbb; display: block; margin-top: 20px; font-weight: bold; }

        .room-tag { color: #555; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 20px; letter-spacing: 2px; }
        .room-code-display { color: var(--gold); font-weight: bold; font-size: 1.2rem; }

        .setup-container { 
            background: var(--panel); padding: 25px; border-radius: 20px; border: 1px solid var(--border); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding-bottom: 40px;
        }

        input[type="text"], select { 
            width: 100%; padding: 14px; margin: 8px 0 12px 0; border-radius: 12px; 
            border: 1px solid #444; background: #000; color: #fff; box-sizing: border-box; font-size: 1rem; outline: none;
        }

        .veto-container { text-align: left; margin: 15px 0 25px 0; padding: 15px; background: #080808; border-radius: 12px; border: 1px solid #222; }
        .veto-title { font-size: 0.7rem; color: var(--gold); text-transform: uppercase; margin-bottom: 12px; display: block; letter-spacing: 1px; }
        .veto-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .veto-option { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: #999; cursor: pointer; }
        .veto-option input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--gold); cursor: pointer; margin: 0; }

        #bi-special-ui { display: none; grid-column: span 2; padding-top: 12px; border-top: 1px solid #222; margin-top: 5px; color: var(--red); font-weight: bold; }

        .player-item { 
            background: #1a1a1a; padding: 15px; margin: 12px 0; border-radius: 14px; 
            display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--gold); text-align: left;
        }
        .player-info strong { display: block; font-size: 1.1rem; color: #fff; }
        .player-info small { color: #666; text-transform: uppercase; font-size: 0.65rem; display: block; margin-top: 2px; }

        .action-btns { display: flex; gap: 15px; }
        .edit-btn { color: var(--gold); font-size: 1.3rem; cursor: pointer; }
        .delete-btn { color: #555; font-size: 1.6rem; cursor: pointer; }

        .status-bar { display: flex; justify-content: center; gap: 8px; padding: 15px 5px; flex-wrap: wrap; width: 100%; }
        .p-chip { background: var(--panel); padding: 12px 8px; border-radius: 12px; border: 1px solid var(--border); min-width: 85px; cursor: pointer; transition: 0.3s; }
        .p-chip.active-turn { border-color: var(--gold); box-shadow: 0 0 15px rgba(212,175,55,0.4); transform: scale(1.05); }
        .star-count { color: var(--gold); font-weight: bold; display: block; margin-top: 5px; font-size: 1rem; }

        .card-area { 
            background: var(--panel); border: 2px solid #222; border-radius: 30px; 
            padding: 50px 25px; margin: 10px 0 30px 0; min-height: 380px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.7); position: relative;
        }
        .star-power-active { border-color: var(--gold) !important; box-shadow: 0 0 50px rgba(212,175,55,0.4) !important; }
        .task-text { font-size: 1.8rem; font-weight: bold; text-transform: uppercase; line-height: 1.4; color: #fff; }
        .gold-name { color: var(--gold); text-shadow: 0 0 15px rgba(212,175,55,0.5); }
        
        #timer-display { font-size: 4.5rem; color: var(--gold); font-weight: 900; margin-top: 25px; display: none; }
        #notif-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; }
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-box { background: var(--panel); border: 1px solid var(--gold); padding: 30px; border-radius: 25px; width: 100%; max-width: 400px; }

        .btn { 
            width: 100%; padding: 20px; border-radius: 15px; border: none; 
            font-weight: 800; cursor: pointer; text-transform: uppercase; 
            letter-spacing: 1.5px; margin-bottom: 12px; transition: transform 0.1s, opacity 0.2s; 
            font-size: 1.05rem; box-sizing: border-box;
        }
        .btn:active { transform: scale(0.97); }

        .btn-add { background: #1a1a1a; color: var(--gold); border: 1px solid var(--border); margin-top: 35px; }
        .btn-start { background: var(--gold); color: #000; font-size: 1.25rem; margin-top: 25px; }
        .btn-rules { background: transparent; color: var(--gold); border: 1px solid var(--gold); font-size: 0.95rem; padding: 16px; margin-top: 5px; }
        .btn-next { background: var(--gold); color: #000; font-size: 1.4rem; box-shadow: 0 5px 25px rgba(212, 175, 55, 0.4); }
        .btn-back { background: #222; color: #eee; border: 1px solid #444; font-size: 1rem; margin-top: 15px; }
        .btn-lvl-up { background: #1a1a1a; color: var(--gold); border: 1px solid var(--gold); font-size: 0.8rem; padding: 10px; margin-top: 10px; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: var(--gold); font-weight: bold; text-transform: uppercase; }
        
        .host-only { display: none; }
        .is-host .host-only { display: block; }
        .guest-only { display: none; }
        .is-guest .guest-only { display: block; }

        .btn-reset-danger { 
            background: #1a1111; 
            color: #666; 
            border: 1px solid #300; 
            font-size: 0.75rem; 
            padding: 12px; 
            margin: 50px auto 20px auto; 
            width: auto; 
            min-width: 220px; 
            display: block;
            cursor: pointer;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #btn-confirm-yes {
            background: var(--red);
            color: #fff;
            font-weight: 800;
            display: none;
        }
    </style>
</head>
<body class="is-host">

    <div id="loading-screen" class="loading-overlay">Laddar Dare Me...</div>

    <!-- INTRO SIDA -->
    <div id="intro-page" class="page active">
        <div class="logo-container">
            <img src="dareme.png" alt="Dare Me Logo">
        </div>
        
        <h1>Dare Me</h1>
        <div class="intro-text-container">
            <span class="intro-title">Welcome to Dare Me</span>
            <div class="intro-body">
                A seductive game of lust and limits.<br>
                Hidden beneath each card, lies more<br> 
                than just a command.<br><br>
                You‚Äôll tease. You‚Äôll surrender. You‚Äôll obey.<br>
                <span class="intro-highlight">The Dare Me isn‚Äôt a game. It‚Äôs desire, waiting to be unwrapped.</span>
            </div>
        </div>
        <button class="btn btn-start" onclick="enterGame()">B√ñRJA SPELET</button>
        <a href="rules.html" class="btn btn-rules" style="text-decoration:none; display:block;">REGLER & SAMTYCKE</a>
    </div>

    <!-- STARTV√ÑLJARE (SKAPA RUM-SIDAN) -->
    <div id="start-page" class="page">
        <div class="logo-container">
            <img src="dareme.png" alt="Dare Me Logo">
        </div>
        <h1>Dare Me</h1>
        <div class="setup-container">
            <button class="btn btn-start" onclick="initLocalGame()">SPELA P√Ö DENNA ENHET</button>
            <div style="margin: 20px 0; color: #444;">‚Äî ELLER SYNKAT L√ÑGE ‚Äî</div>
            <button class="btn btn-add" onclick="initCreateRoom()">SKAPA RUM (HOST)</button>
            <input type="text" id="join-code-input" placeholder="ANGE RUMSKOD" maxlength="5" style="text-align: center; margin-top: 10px;">
            <button class="btn btn-add" onclick="initJoinRoom()">G√Ö MED I RUM</button>
        </div>
    </div>

    <!-- NOTIFIERING -->
    <div id="notif-overlay" onclick="this.style.display='none'">
        <div class="notif-content">
            <div style="font-size: 6rem;">‚≠ê</div>
            <h2 id="notif-player-name">NAMN</h2>
            <p style="color: #fff; font-size: 1.4rem; font-weight: bold;">VANN EN GULDSTJ√ÑRNA!</p>
            <small style="color:#666; margin-top:20px; display:block;">Tryck f√∂r att forts√§tta</small>
        </div>
    </div>

    <!-- MODAL-BEH√ÖLLARE (VARNINGAR, STJ√ÑRNOR & RESET) -->
    <div id="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-player-name" style="color:var(--gold); margin-top:0; text-transform:uppercase;">INFO</h3>
            <div id="modal-star-info" style="margin-bottom: 25px; color:#888;">
                <span id="modal-msg-text">Meddelande...</span> 
                <span id="modal-star-count" style="color:var(--gold)"></span>
            </div>
            
            <button class="btn btn-next" id="btn-use-star" onclick="activateStarPower()">ANV√ÑND GULDSTJ√ÑRNA ‚≠ê</button>
            <button class="btn btn-add host-only" id="manual-star-btn" onclick="manualAddStar()">GE EN BONUS-STJ√ÑRNA üéÅ</button>
            <button class="btn" id="btn-confirm-yes" onclick="confirmReset()">JA, RADERA ALLT</button>
            
            <button class="btn btn-back" id="btn-modal-close" onclick="closeModal()" style="margin-top:10px;">AVBRYT</button>
        </div>
    </div>

    <!-- LOBBY -->
    <div id="lobby-page" class="page">
        <h1>Dare Me</h1>
        <div class="small-logo">
            <img src="dareme.png" alt="Dare Me Logo">
        </div>

        <div id="room-info" class="room-tag">LOKALT SPEL</div>
        <div class="setup-container">
            <div id="setup-controls">
                <input type="text" id="pName" placeholder="DITT NAMN" autocomplete="off">
                <select id="pGender" onchange="toggleBiOption()"><option value="kvinna">KVINNA</option><option value="man">MAN</option></select>
                <select id="pPref" onchange="toggleBiOption()"><option value="bi" selected>BISEXUELL</option><option value="hetero">HETEROSEXUELL</option><option value="gay">HOMOSEXUELL</option></select>
                
                <div class="veto-container host-only">
                    <span class="veto-title">Globala Inst√§llningar (Endast V√§rd)</span>
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
                        <label class="veto-option" style="margin: 0;"><input type="checkbox" id="setting-manual-stars" onchange="toggleManualStars()"> Manuella stj√§rnor</label>
                        <div class="veto-option" style="gap: 8px; margin: 0;">
                            <span style="font-size: 0.65rem; color: var(--gold); text-transform: uppercase;">Timer:</span>
                            <select id="star-timer-setting" onchange="updateStarTimerSetting()" style="width: auto; padding: 6px 10px; margin: 0; font-size: 0.8rem; border-radius: 8px; background: #000; color: #fff; border: 1px solid #444; outline: none;">
                                <option value="1">1 min</option><option value="2">2 min</option><option value="3" selected>3 min</option><option value="4">4 min</option><option value="5">5 min</option>
                            </select>
                        </div>
                        <div class="veto-option" style="gap: 8px; margin: 0;">
                            <span style="font-size: 0.65rem; color: var(--gold); text-transform: uppercase;">Chans:</span>
                            <select id="star-chance-setting" onchange="updateStarChanceSetting()" style="width: auto; padding: 6px 10px; margin: 0; font-size: 0.8rem; border-radius: 8px; background: #000; color: #fff; border: 1px solid #444; outline: none;">
                                <option value="1">1%</option><option value="2">2%</option><option value="3" selected>3%</option><option value="4">4%</option><option value="5">5%</option><option value="6">6%</option><option value="7">7%</option><option value="8">8%</option><option value="9">9%</option><option value="10">10%</option>
                            </select>
                        </div>
                    </div>
                    <div style="border-top: 1px solid #222; padding-top: 15px;">
                        <small style="color: var(--gold); display: block; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Tillg√§ngliga Niv√•er:</small>
                        <div id="level-selection-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                            <div id="lvl-scanner-status" style="color:#444; font-size:0.7rem;">S√∂ker efter filer...</div>
                        </div>
                    </div>
                </div>

                <div class="guest-only" style="text-align: left; font-size: 0.65rem; color: #555; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
                    Timer: <span id="guest-timer-info" style="color: var(--gold); font-weight: bold; margin-right: 15px;">3 min</span>
                    Chans: <span id="guest-chance-info" style="color: var(--gold); font-weight: bold;">3%</span>
                </div>

                <div class="veto-container">
                    <span class="veto-title">Vetos (Detta vill jag INTE g√∂ra)</span>
                    <div class="veto-grid">
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="smisk"> Smisk</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="oral"> Oralt</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="penetration"> Penetration</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="bindning"> Bindning/BDSM</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="leksaker"> Sexleksaker</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="publik"> Publik/Utomhus</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="impact"> Impact play</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="analt"> Analt</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="dominans"> Dominans</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="underkastelse"> Underkastelse</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="fornedring"> F√∂rnedring</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="ogonbindel"> √ñgonbindel/Blindfold</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="fotter"> F√∂tter</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="semen"> Sperma</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="blood"> Blod</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="wet"> Wet (Kissa)</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="wax"> Stearin</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="rollspel"> Rollspel</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="kon"> K√∂n</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="onani"> Onani</label>
                        <label class="veto-option"><input type="checkbox" class="veto-cb" value="bitas"> Bitas</label>
                        <label class="veto-option" id="bi-special-ui"><input type="checkbox" id="bi-no-pen"> Bi-Sex Ingen penetration</label>
                    </div>
                </div>
                <button class="btn btn-add" onclick="addPlayer()">L√ÑGG TILL MIG</button>
            </div>
            <div id="displayList" style="margin-top: 20px;"></div>
            <div class="host-only">
                <button class="btn btn-start" id="start-game-btn" onclick="startGame()">STARTA SPELET</button>
            </div>
            <div class="guest-only" style="margin-top: 30px; color: #666; font-style: italic;">V√§ntar p√• att v√§rden ska starta...</div>
            
            <a href="rules.html" onclick="saveLocal()" class="btn btn-rules" style="text-decoration:none; display:block; margin-top:20px;">VISA REGLER</a>
            
            <button class="btn btn-reset-danger" onclick="requestReset()">Nollst√§ll allt / Byt roll</button>
        </div>
    </div>

    <!-- GAME -->
    <div id="game-page" class="page">
        <div id="player-status" class="status-bar"></div>
        <div class="card-area" id="game-card">
            <div id="next-up-info" style="color:#faa405; font-size:0.8rem; text-transform:uppercase; margin-bottom:5px;">N√ÑSTA P√Ö TUR: ...</div>
            <div id="active-lvl-display" style="color: #444; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 10px;">NIV√Ö: <span id="current-lvl-text" style="color:var(--red); font-weight:bold;">---</span></div>
            <div id="star-power-label" style="color:var(--gold); font-weight:bold; letter-spacing:5px; margin-bottom:20px; display:none;">‚≠ê GULDSTJ√ÑRNA ‚≠ê</div>
            <div id="task-box" class="task-text">V√ÑNTAR p√• kort...</div>
            <div id="timer-display">3:00</div>
            <button id="btn-finish-timer" class="btn btn-lvl-up" style="display:none;" onclick="finishTimerEarly()">KLART, N√ÑSTA KORT</button>
        </div>
        <div class="game-controls">
            <button class="btn btn-next" onclick="generateTurn()">N√ÑSTA KORT</button>
            <button class="btn btn-rules" style="margin-bottom: 25px;" onclick="skipCard()">BYT KORT üîÑ</button>
            <button class="btn btn-lvl-up host-only" id="lvl-up-btn" onclick="advanceLevel()">H√ñJ ST√ÑMNINGEN üî•</button>
            <button class="btn btn-back" style="margin-top: 30px;" onclick="goToLobby()">LOBBY / REDIGERA</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "firebase/app";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "firebase/auth";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "firebase/firestore";
    import { getAnalytics, logEvent } from "firebase/analytics";

    // √ÖTERST√ÑLLER API-NYCKEL TILL DEN SOM FUNGERAR F√ñR FIRESTORE
    const firebaseConfig = {
      apiKey: "AIzaSyADzIduNhKHBKIMWMGIwwPtiqKkZk8xZK4",
      authDomain: "dare-me-1c264.firebaseapp.com",
      projectId: "dare-me-1c264",
      storageBucket: "dare-me-1c264.firebasestorage.app",
      messagingSenderId: "1002052194460",
      appId: "1:1002052194460:web:9f55d47fbc82745a17dd59",
      measurementId: "G-SZC2F73JDZ"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    let allDares = {}; 
    let tempStars = 0; 
    
    let state = {
        introSeen: false,
        modeSelected: false,
        isHost: false,
        players: [],
        selectedLevels: [],
        activeLevelIdx: 0,
        currentPlayerIdx: 0,
        allowManualStars: false,
        starPowerDuration: 3,
        starChance: 3,
        currentTask: "TRYCK F√ñR KORT",
        timer: null,
        isPlaying: false,
        roomCode: null
    };

    let isHost = false, lastStarCounts = {}, db, auth, unsubscribe, user;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'dare-me-dynamic';

    function hideLoading() { document.getElementById('loading-screen').style.display = 'none'; }

    async function scanForLevels() {
        const grid = document.getElementById('level-selection-grid');
        const statusText = document.getElementById('lvl-scanner-status');
        if (!grid) return;
        
        let foundCount = 0;
        let htmlBuffer = "";

        for (let i = 1; i <= 20; i++) {
            try {
                const res = await fetch(`level${i}.json?t=${Date.now()}`);
                if (res.ok) {
                    const data = await res.json();
                    allDares[i] = data;
                    const isChecked = state.selectedLevels.includes(i) ? 'checked' : '';
                    htmlBuffer += `<label class="veto-option"><input type="checkbox" class="lvl-cb" value="${i}" ${isChecked} onchange="toggleLevelSelection()"> ${data.difficulty || 'üå∂Ô∏è'} ${data.name || 'Niv√• ' + i}</label>`;
                    foundCount++;
                }
            } catch (e) { console.warn(`Kunde inte l√§sa in level${i}.json.`, e); }
        }

        if (foundCount > 0) {
            grid.innerHTML = htmlBuffer;
        } else {
            if (statusText) statusText.innerText = "Inga niv√•-filer hittades.";
        }
    }

    window.toggleLevelSelection = () => {
        state.selectedLevels = Array.from(document.querySelectorAll('.lvl-cb:checked'))
            .map(cb => parseInt(cb.value))
            .sort((a,b) => a-b);
        saveLocal(); 
    };

    async function initFirebase() {
        try {
            auth = getAuth(app); db = getFirestore(app);
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            onAuthStateChanged(auth, (u) => {
                user = u;
                if (u && state.roomCode) listenToRoom(state.roomCode);
            });
            return true;
        } catch (e) { return false; }
    }

    async function updateCloud() {
        if (!state.roomCode || !db || !user) return;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', state.roomCode), state);
    }

    function showStarNotif(name) {
        document.getElementById('notif-player-name').innerText = name;
        document.getElementById('notif-overlay').style.display = 'flex';
        setTimeout(() => { 
            const overlay = document.getElementById('notif-overlay');
            if(overlay) overlay.style.display='none'; 
        }, 4000);
    }

    function listenToRoom(code) {
        if (!db || !user) return;
        if (unsubscribe) unsubscribe();
        unsubscribe = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code), (snapshot) => {
            if (snapshot.exists()) {
                const cloudData = snapshot.data();
                if (cloudData.players) {
                    cloudData.players.forEach(p => {
                        if (lastStarCounts[p.id] !== undefined && p.stars > lastStarCounts[p.id]) {
                            showStarNotif(p.name);
                        }
                        lastStarCounts[p.id] = p.stars;
                    });
                }
                if (!isHost && (cloudData.isPlaying || JSON.stringify(cloudData.selectedLevels) !== JSON.stringify(state.selectedLevels))) {
                    state.selectedLevels = cloudData.selectedLevels;
                    for (let id of state.selectedLevels) {
                        if (!allDares[id]) {
                            fetch(`level${id}.json?t=${Date.now()}`).then(res => {
                                if (res.ok) res.json().then(data => allDares[id] = data);
                            });
                        }
                    }
                }
                state = { ...state, ...cloudData };
                applyStateToUI();
            }
        }, (err) => { console.error("Snapshot error:", err); });
    }

    function applyStateToUI() {
        isHost = state.isHost;
        const pages = ['intro-page', 'start-page', 'lobby-page', 'game-page'];
        pages.forEach(p => {
            const el = document.getElementById(p);
            if (el) el.classList.remove('active');
        });
        document.body.className = isHost ? "is-host" : "is-guest";
        
        if (isHost) {
            const manStarsCb = document.getElementById('setting-manual-stars');
            if (manStarsCb) manStarsCb.checked = state.allowManualStars;
            const timerSel = document.getElementById('star-timer-setting');
            if (timerSel) timerSel.value = state.starPowerDuration || 3;
            const chanceSel = document.getElementById('star-chance-setting');
            if (chanceSel) chanceSel.value = state.starChance || 3;
        }

        if (!state.introSeen) {
            document.getElementById('intro-page').classList.add('active');
        } else if (!state.modeSelected) {
            document.getElementById('start-page').classList.add('active');
        } else if (state.isPlaying) {
            document.getElementById('game-page').classList.add('active');
            renderGameBar();
            document.getElementById('task-box').innerHTML = state.currentTask;
            const curLvlId = state.selectedLevels[state.activeLevelIdx];
            document.getElementById('current-lvl-text').innerText = curLvlId <= 2 ? (allDares[curLvlId]?.name || `Niv√• ${curLvlId}`) : "üî• THE SHUFFLE ZONE";
            document.getElementById('lvl-up-btn').style.display = (isHost && curLvlId < 3 && state.activeLevelIdx < state.selectedLevels.length - 1) ? 'block' : 'none';
            if (state.timer) {
                document.getElementById('timer-display').style.display = 'block';
                document.getElementById('timer-display').innerText = state.timer;
                document.getElementById('game-card').classList.add('star-power-active');
                document.getElementById('star-power-label').style.display = 'block';
                document.getElementById('btn-finish-timer').style.display = 'block';
            } else {
                document.getElementById('timer-display').style.display = 'none';
                document.getElementById('game-card').classList.remove('star-power-active');
                document.getElementById('star-power-label').style.display = 'none';
                document.getElementById('btn-finish-timer').style.display = 'none';
            }
        } else {
            document.getElementById('lobby-page').classList.add('active');
            renderLobby();
        }
        const roomInfo = document.getElementById('room-info');
        if (roomInfo) roomInfo.innerHTML = state.roomCode ? `RUMSKOD: <span class="room-code-display">${state.roomCode}</span>` : `LOKALT SPEL`;
        hideLoading();
    }

    window.updateStarTimerSetting = () => { state.starPowerDuration = parseInt(document.getElementById('star-timer-setting').value); updateCloud(); saveLocal(); };
    window.updateStarChanceSetting = () => { state.starChance = parseInt(document.getElementById('star-chance-setting').value); updateCloud(); saveLocal(); };
    window.toggleManualStars = () => { state.allowManualStars = document.getElementById('setting-manual-stars').checked; updateCloud(); saveLocal(); };
    window.enterGame = () => { state.introSeen = true; applyStateToUI(); saveLocal(); };

    window.initLocalGame = async () => { isHost = true; state.isHost = true; state.modeSelected = true; state.roomCode = null; await scanForLevels(); saveLocal(); applyStateToUI(); };
    window.initCreateRoom = async () => {
        const ok = await initFirebase(); if (!ok) return;
        isHost = true; state.isHost = true; state.modeSelected = true;
        state.roomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
        await scanForLevels(); listenToRoom(state.roomCode); updateCloud(); saveLocal(); applyStateToUI();
    };
    window.initJoinRoom = async () => {
        const code = document.getElementById('join-code-input').value.toUpperCase();
        if(!code) return;
        const ok = await initFirebase(); if (!ok) return;
        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code));
        if (!snap.exists()) return;
        isHost = false; state.isHost = false; state.modeSelected = true; state.roomCode = code; listenToRoom(code); applyStateToUI();
    };

    window.addPlayer = () => {
        const nameInput = document.getElementById('pName');
        const name = nameInput.value.trim().toUpperCase();
        if (!name) return;
        const finalStars = tempStars; tempStars = 0;
        state.players.push({
            id: Date.now(), name, gender: document.getElementById('pGender').value,
            pref: document.getElementById('pPref').value, vetos: Array.from(document.querySelectorAll('.veto-cb:checked')).map(cb => cb.value), 
            biNoPen: document.getElementById('bi-no-pen').checked, stars: finalStars
        });
        nameInput.value = ""; document.querySelectorAll('.veto-cb').forEach(cb => cb.checked = false);
        renderLobby(); updateCloud(); toggleBiOption(); saveLocal();
    };

    window.removePlayer = (id) => { state.players = state.players.filter(p => p.id !== id); renderLobby(); updateCloud(); saveLocal(); };
    
    window.editPlayer = (id) => {
        const p = state.players.find(x => x.id === id); if (!p) return;
        tempStars = p.stars;
        document.getElementById('pName').value = p.name; document.getElementById('pGender').value = p.gender;
        document.getElementById('pPref').value = p.pref; document.querySelectorAll('.veto-cb').forEach(cb => cb.checked = p.vetos.includes(cb.value));
        toggleBiOption(); removePlayer(id);
    };

    window.startGame = () => {
        if (!isHost) return;
        state.selectedLevels = Array.from(document.querySelectorAll('.lvl-cb:checked')).map(cb => parseInt(cb.value)).sort((a,b)=>a-b);
        if (state.selectedLevels.length === 0) { showLobbyWarning("Du m√•ste v√§lja minst en niv√•fil f√∂r att kunna starta."); return; }
        if (state.players.length < 2) { showLobbyWarning("Det kr√§vs minst tv√• spelare f√∂r att kunna b√∂rja."); return; }
        state.isPlaying = true; state.activeLevelIdx = 0; state.currentPlayerIdx = 0; updateCloud(); saveLocal(); applyStateToUI();
    };

    window.generateTurn = () => {
        if (state.timer) stopTimer();
        const active = state.players[state.currentPlayerIdx];
        const validTargets = state.players.filter(p => p.id !== active.id);
        if (validTargets.length === 0) return;
        const target = validTargets[Math.floor(Math.random() * validTargets.length)];
        const curLvlId = state.selectedLevels[state.activeLevelIdx];
        let pool = [];
        if (curLvlId <= 2) pool = (allDares[curLvlId]?.dares || []);
        else state.selectedLevels.filter(id => id > 2).forEach(id => { if (allDares[id]) pool = pool.concat(allDares[id].dares); });

        const filteredPool = pool.filter(d => {
            if (d.tags && d.tags.some(tag => target.vetos.includes(tag) || active.vetos.includes(tag))) return false;
            if (active.gender === 'man' && target.gender === 'man' && target.pref === 'bi' && target.biNoPen && d.tags?.includes('penetration')) return false;
            return true;
        });

        if (filteredPool.length === 0) state.currentTask = "INGA MATCHANDE KORT HITTADES.";
        else {
            const dare = filteredPool[Math.floor(Math.random() * filteredPool.length)];
            const ts = target.name + (target.name.endsWith('S') ? '' : 'S');
            const pronomen = target.gender === 'man' ? 'honom' : 'henne';
            const pronomenPossessiv = target.gender === 'man' ? 'hans' : 'hennes';
            state.currentTask = `<span class="gold-name">${active.name}</span>, ${dare.text}`.replace(/\[TARGETS\]/g, `<span class="gold-name">${ts}</span>`).replace(/\[TARGET\]/g, `<span class="gold-name">${target.name}</span>`).replace(/\[HEN\]/g, pronomen).replace(/\[HENS\]/g, pronomenPossessiv);
            if (Math.random() < (state.starChance/100) && active.stars < 4) { active.stars++; if (!state.roomCode) showStarNotif(active.name); }
            state.currentPlayerIdx = (state.currentPlayerIdx + 1) % state.players.length;
        }
        updateCloud(); saveLocal(); applyStateToUI();
    };

    window.skipCard = () => {
        const activeIdx = (state.currentPlayerIdx - 1 + state.players.length) % state.players.length;
        state.currentPlayerIdx = activeIdx; 
        window.generateTurn();
    };

    window.advanceLevel = () => { if(isHost && state.activeLevelIdx < state.selectedLevels.length - 1) { state.activeLevelIdx++; updateCloud(); saveLocal(); } };
    
    window.activateStarPower = () => {
        const active = state.players[selectedPlayerIndex];
        active.stars--; closeModal();
        state.currentTask = `<span class="gold-name">${active.name}</span>, DU HAR KONTROLLEN! Best√§m vad de andra ska g√∂ra.`;
        startTimer((state.starPowerDuration || 3) * 60);
        updateCloud(); saveLocal();
    };

    window.showLobbyWarning = (msg) => {
        document.getElementById('modal-player-name').innerText = "OBS!";
        document.getElementById('modal-msg-text').innerText = msg;
        document.getElementById('modal-star-count').innerText = "";
        document.getElementById('btn-use-star').style.display = 'none';
        document.getElementById('manual-star-btn').style.display = 'none';
        document.getElementById('btn-confirm-yes').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'flex';
    };

    window.requestReset = () => {
        document.getElementById('modal-player-name').innerText = "√ÑR DU S√ÑKER?";
        document.getElementById('modal-msg-text').innerText = "Detta raderar alla spelare, inst√§llningar och din roll som v√§rd p√• denna enhet.";
        document.getElementById('modal-star-count').innerText = "";
        
        document.getElementById('btn-use-star').style.display = 'none';
        document.getElementById('manual-star-btn').style.display = 'none';
        document.getElementById('btn-confirm-yes').style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'flex';
    };

    window.confirmReset = () => { localStorage.clear(); location.reload(); };

    let selectedPlayerIndex = -1;
    window.openStarModal = (i) => {
        selectedPlayerIndex = i; const p = state.players[i];
        document.getElementById('modal-player-name').innerText = p.name;
        document.getElementById('modal-msg-text').innerText = "Antal Guldstj√§rnor: ";
        document.getElementById('modal-star-count').innerText = p.stars;
        document.getElementById('btn-use-star').style.display = p.stars > 0 ? 'block' : 'none';
        document.getElementById('manual-star-btn').style.display = (isHost && state.allowManualStars) ? 'block' : 'none';
        document.getElementById('btn-confirm-yes').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'flex';
    };
    
    window.closeModal = () => { 
        document.getElementById('modal-overlay').style.display = 'none'; 
        document.getElementById('btn-confirm-yes').style.display = 'none';
    };

    window.manualAddStar = () => { if(isHost && state.players[selectedPlayerIndex].stars < 4) { state.players[selectedPlayerIndex].stars++; updateCloud(); saveLocal(); closeModal(); } };
    
    function startTimer(sec) {
        let timeLeft = sec;
        const tick = () => {
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            state.timer = `${m}:${s<10?'0':''}${s}`;
            timeLeft--;
            if (timeLeft < 0) { state.timer = "KLART!"; clearInterval(window.tInt); }
            updateCloud(); saveLocal(); applyStateToUI();
        };
        clearInterval(window.tInt); window.tInt = setInterval(tick, 1000); tick();
    }
    window.finishTimerEarly = () => { clearInterval(window.tInt); state.timer = null; updateCloud(); applyStateToUI(); };
    function stopTimer() { clearInterval(window.tInt); state.timer = null; }
    
    function renderLobby() { 
        document.getElementById('displayList').innerHTML = state.players.map(p => `
            <div class="player-item">
                <div class="player-info"><strong>${p.name}</strong><small>${p.gender} ‚Ä¢ ${p.pref}</small></div>
                <div class="action-btns"><span class="edit-btn" onclick="editPlayer(${p.id})">‚úé</span><span class="delete-btn" onclick="removePlayer(${p.id})">√ó</span></div>
            </div>`).join(''); 
    }
    
    function renderGameBar() { 
        const activeIdx = (state.currentTask === "TRYCK F√ñR KORT") ? -1 : (state.currentPlayerIdx - 1 + state.players.length) % state.players.length;
        document.getElementById('player-status').innerHTML = state.players.map((p, i) => `
            <div class="p-chip ${activeIdx === i ? 'active-turn' : ''}" onclick="openStarModal(${i})">
                <strong>${p.name}</strong><div class="star-count">${"‚≠ê".repeat(p.stars)||0}</div>
            </div>`).join(''); 
    }
    
    window.toggleBiOption = () => { 
        const gender = document.getElementById('pGender').value;
        const pref = document.getElementById('pPref').value;
        const biUi = document.getElementById('bi-special-ui');
        if (biUi) biUi.style.display = (gender === 'man' && pref === 'bi') ? 'block' : 'none'; 
    };

    function saveLocal() { localStorage.setItem('dareme_state', JSON.stringify(state)); }
    window.goToLobby = () => { state.isPlaying = false; applyStateToUI(); updateCloud(); saveLocal(); };

    window.addEventListener('load', () => { 
        const saved = localStorage.getItem('dareme_state');
        if (saved) { state = { ...state, ...JSON.parse(saved) }; }
        initFirebase().then(async () => { 
            await scanForLevels(); 
            hideLoading(); 
            toggleBiOption(); 
            applyStateToUI();
            // EXTRA TRIGGER F√ñR ANALYTICS REALTIME
            logEvent(analytics, 'app_open', { platform: 'web' });
        });
    });
</script>
</body>
</html>
